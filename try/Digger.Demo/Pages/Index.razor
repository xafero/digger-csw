@page "/"

@using System.Timers
@using DiggerDemo.Core
@using SkiaSharp.Views.Blazor
@using Dig = DiggerClassic.Core.Digger;

<SKGLView Width="1024px" Height="1024px" @ref="_form" />

@code {
	private WebDigger _web;
	private SKGLView _form;
	private Dig _game;
	private Timer _timer;

	protected override void OnAfterRender(bool firstRender)
	{
		if (firstRender)
		{
			_web = new WebDigger(null) { _canvas = _form };
			_form.IgnorePixelScaling = true;
			_form.EnableRenderLoop = false;
			_form.OnPaintSurface = _web.PaintSurface;

			_game = new Dig(_web);
			_web._digger = _game;
			_web.SetFocusable();
			_game.Init();
			_game.Start();

			_timer = new Timer(250);
			_timer.Elapsed += NotifyTimerElapsed;
			_timer.Enabled = true;
		}
	}

	private async void NotifyTimerElapsed(object _, ElapsedEventArgs e)
	{
		_timer.Enabled = false;
		await _web._digger.RunAsync();
	}
}
